<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydra-vdo.ninja Streaming Loopback Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: #404040;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #505050; }
        button.active { background: #606060; }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.streaming { background: #2a5c2a; }
        .status.stopped { background: #5c2a2a; }
        .view-link {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .view-link input {
            width: 100%;
            background: #1a1a1a;
            color: white;
            border: 1px solid #404040;
            padding: 8px;
            border-radius: 4px;
        }
        .canvas-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .canvas-box {
            border: 2px solid #404040;
            border-radius: 4px;
            padding: 10px;
            background: #2a2a2a;
        }
        .canvas-box h3 {
            margin: 0 0 10px 0;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hydra-vdo.ninja Streaming Loopback Test</h1>
        <p>This test demonstrates streaming Hydra visuals to vdo.ninja and receiving the stream back into Hydra.</p>

        <div class="controls">
            <button id="startStream">Start Stream</button>
            <button id="stopStream">Stop Stream</button>
            <button id="copyLink">Copy View Link</button>
            <button id="startLoopback">Start Loopback</button>
        </div>

        <div class="view-link" id="viewLinkContainer" style="display: none;">
            <label>View Link (open this in another tab to test streaming):</label>
            <input type="text" id="viewLink" readonly>
        </div>

        <div class="status" id="status">
            Stream Status: Stopped
        </div>

        <div class="canvas-container">
            <div class="canvas-box">
                <h3>Original Hydra Canvas</h3>
                <div id="hydra-container"></div>
            </div>
            <div class="canvas-box">
                <h3>Composite Canvas (Streaming)</h3>
                <canvas id="compositePreview" width="640" height="360"></canvas>
            </div>
            <div class="canvas-box">
                <h3>Loopback Stream (Received)</h3>
                <video id="loopbackVideo" width="640" height="360" autoplay muted></video>
            </div>
        </div>

        <div id="loopbackStatus"></div>
    </div>

    <!-- Load Hydra -->
    <script src="https://unpkg.com/hydra-synth"></script>

    <!-- Load our integration library -->
    <script src="hydra-vdo-ninja.js"></script>
    <script src="hydra-vdo-ninja-integration.js"></script>

    <script>
        let hydraVdo = null;
        let streamId = null;
        let loopbackPeerConnection = null;

        // Initialize Hydra
        const hydraSynth = new Hydra({
            detectAudio: false,
            makeGlobal: true,
            width: 640,
            height: 360
        });

        // Create dynamic Hydra visuals
        osc(10, 0.1, 1.2)
            .rotate(() => time * 0.1)
            .kaleid(4)
            .out();

        // Initialize vdo.ninja integration
        hydraVdo = new HydraVdoNinja(hydraSynth, {
            width: 640,
            height: 360,
            fps: 30
        });

        // Update composite canvas preview
        function updateCompositePreview() {
            const previewCanvas = document.getElementById('compositePreview');
            const ctx = previewCanvas.getContext('2d');

            if (hydraVdo && hydraVdo.compositeCanvas) {
                ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                ctx.drawImage(hydraVdo.compositeCanvas, 0, 0);
            }

            requestAnimationFrame(updateCompositePreview);
        }
        updateCompositePreview();

        // Event handlers
        document.getElementById('startStream').addEventListener('click', () => {
            streamId = 'hydra_loopback_' + Math.random().toString(36).substr(2, 8);
            const result = hydraVdo.startVDOStream({
                pushId: streamId,
                roomName: 'loopback_test'
            });

            document.getElementById('viewLink').value = result.viewLink;
            document.getElementById('viewLinkContainer').style.display = 'block';
            updateStatus('streaming');

            console.log('Stream started with ID:', streamId);
            console.log('View link:', result.viewLink);
        });

        document.getElementById('stopStream').addEventListener('click', () => {
            hydraVdo.stopStreaming();
            updateStatus('stopped');

            if (loopbackPeerConnection) {
                loopbackPeerConnection.close();
                loopbackPeerConnection = null;
            }
        });

        document.getElementById('copyLink').addEventListener('click', () => {
            hydraVdo.copyViewLink();
            alert('View link copied to clipboard!');
        });

        document.getElementById('startLoopback').addEventListener('click', () => {
            if (!streamId) {
                alert('Please start a stream first');
                return;
            }
            startLoopbackReceiver();
        });

        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `Stream Status: ${status === 'streaming' ? 'Streaming' : 'Stopped'}`;
            statusEl.className = `status ${status}`;
        }

        // Loopback receiver - simulates receiving the stream
        async function startLoopbackReceiver() {
            try {
                const statusEl = document.getElementById('loopbackStatus');
                statusEl.innerHTML = '<div class="status streaming">Attempting to receive stream...</div>';

                // Create a simple WebRTC receiver
                const video = document.getElementById('loopbackVideo');

                // For this demo, we'll create a mock receiver that uses the composite canvas
                // In a real scenario, you'd connect to the actual vdo.ninja stream
                const stream = hydraVdo.compositeCanvas.captureStream(30);
                video.srcObject = stream;

                statusEl.innerHTML = '<div class="status streaming">Loopback active - displaying composite canvas stream</div>';

                console.log('Loopback receiver started');

            } catch (error) {
                console.error('Loopback receiver failed:', error);
                document.getElementById('loopbackStatus').innerHTML =
                    '<div class="status stopped">Loopback failed: ' + error.message + '</div>';
            }
        }

        // Advanced: Try to receive actual vdo.ninja stream
        async function receiveActualStream() {
            if (!streamId) return;

            try {
                // This would require setting up a proper WebRTC connection to vdo.ninja
                // For now, we'll demonstrate the concept
                console.log('To receive the actual stream, open this URL in another tab:');
                console.log('https://vdo.ninja/?view=' + streamId);

                alert('Open the view link in another tab to see the actual stream working');

            } catch (error) {
                console.error('Failed to receive actual stream:', error);
            }
        }

        // Auto-start stream for demo
        setTimeout(() => {
            document.getElementById('startStream').click();
            setTimeout(() => {
                document.getElementById('startLoopback').click();
            }, 2000);
        }, 1000);
    </script>
</body>
</html>

